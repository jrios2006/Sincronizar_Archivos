# Proyecto Inventario de Archivos

Este proyecto permite sincronizar metadatos de ficheros locales en una base de datos MariaDB.
Se registran nombre, ruta, hash MD5, tamaÃ±o, fechas, extensiÃ³n y tipo MIME, manteniendo la tabla siempre sincronizada:

* Inserta archivos nuevos.
* Actualiza archivos modificados.
* Elimina registros de archivos que ya no existen.
* Sube el contenido actual de esa carpeta en un fichero json a varios sitios de un servidor remoto de ficheros

---

## Estructura del proyecto

```bash
proyecto_inventario/
â”‚
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ config.json           # ParÃ¡metros generales (directorio base, tabla, etc.)
â”‚   â””â”€â”€ credenciales.json     # Credenciales de base de datos y otros servicios
â”‚
â”œâ”€â”€ sql/
â”‚   â””â”€â”€ create_archivos.sql   # Script SQL para crear la tabla con comentarios
â”‚
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ logging_config.py     # Funciones genÃ©ricas para tener un log del programa
â”‚   â”œâ”€â”€ export.py             # Funciones genÃ©ricas para exportar informaciÃ³n de BBDD a SFTP
â”‚   â”œâ”€â”€ utils.py              # Funciones genÃ©ricas (cargar JSON)
â”‚   â”œâ”€â”€ db.py                 # Funciones de conexiÃ³n y consultas a la base de datos
â”‚   â”œâ”€â”€ files.py              # Utilidades para leer metadatos de ficheros
â”‚   â”œâ”€â”€ ssh.py                # Utilidades para usar un servidor ssh (sftp)
â”‚   â””â”€â”€ sync.py               # Algoritmo de sincronizaciÃ³n
â”‚
â”œâ”€â”€ main.py                   # Punto de entrada principal
â””â”€â”€ README.md                 # DocumentaciÃ³n del proyecto

```

---

## âš™ï¸ ConfiguraciÃ³n

`config/config.json`

```json
{
  "directorio_base": "/ruta/a/tu/carpeta",
  "tabla": "archivos",
  "fichero_a_exportar": "listado_archivos.json",
  "rutas_remotas_a_exportar": [
    "/ruta1"
  ],
  "log": {
    "ruta_log": "logs/sincronizar_archivos.log",
    "max_megas": 5,
    "copias": 5
  }
}

```

`config/credenciales.json`

```json
{
  "BBDD": {
    "user": "inventario_user",
    "password": "inventario_pass",
    "host": "localhost",
    "port": 3306,
    "database": "inventario_db"
  },
  "SFTP": [
    "server_SFTP",
    2222,
    "USER_SFTP",
    "PASS_SFTP",
    "",
    ""
  ]
}
```

---

## ğŸ—„ï¸ Base de datos

El script sql/create_archivos.sql crea la tabla para almacenar los metadatos con comentarios

Verifica que la tabla que se crea estÃ¡ correctamente puesta en `config.json`

---

## Requerimientos

Instala las dependencias necesarias (Python 3.9+):

```bash
pip install mariadb paramiko
```

TambiÃ©n se puede instalar mediante el comando

```bash
pip install -r requirements.txt
```

### Dependencias estÃ¡ndar de Python

* os, hashlib, mimetypes, datetime, json.

---

## â–¶ï¸ EjecuciÃ³n

* Configura config/config.json y config/credenciales.json.
* Crea la base de datos y la tabla (ejecutando sql/create_archivos.sql o dejando que el programa lo haga en el primer arranque).

Ejecuta el programa:
```bash
python main.py
```

---

## Logging del programa

El proyecto utiliza el mÃ³dulo logging de Python para registrar la actividad del script. Esto es especialmente Ãºtil cuando se ejecuta desde cron, ya que no hay consola visible.

### âš™ï¸ ConfiguraciÃ³n del log

Los parÃ¡metros del log se configuran en `config/config.json`:

```json
"log": {
  "ruta_log": "logs/sincronizar_archivos.log",
  "max_megas": 5,
  "copias": 5
}
```

* ruta_log: ruta del fichero donde se almacenan los logs.
* max_megas: tamaÃ±o mÃ¡ximo del fichero de log en MB antes de rotar.
* copias: nÃºmero de ficheros de log antiguos que se mantienen (rotaciÃ³n).
* El programa crea automÃ¡ticamente la carpeta logs/ si no existe.

### ğŸ“„ Comportamiento del log

* Se registra informaciÃ³n relevante del programa (INFO, WARNING, ERROR).
* Se silencian los mensajes INFO internos de paramiko, para no llenar el log con informaciÃ³n de SFTP.
* Cuando el fichero de log supera el tamaÃ±o mÃ¡ximo (max_megas), se rota automÃ¡ticamente, creando copias numeradas:

```bash
sincronizar_archivos.log        <-- log actual
sincronizar_archivos.log.1      <-- copia mÃ¡s reciente
sincronizar_archivos.log.2      <-- copia anterior
...
```

### ğŸ“ Ejemplo de entradas en el log

```bash
2025-10-04 17:23:58 [INFO] root: === Inicio de sincronizaciÃ³n de archivos ===
2025-10-04 17:23:59 [INFO] modules.sync: SincronizaciÃ³n completada con 321 archivos
2025-10-04 17:24:00 [INFO] modules.export: Fichero JSON exportado: listado_archivos.json
2025-10-04 17:24:02 [INFO] root: âœ… SincronizaciÃ³n y exportaciÃ³n completadas correctamente.
2025-10-04 17:24:03 [ERROR] modules.ssh: âŒ Error al subir fichero a /ruta1

```

---

## Archivos generados

El programa genera un archivo json que se pone en la tabla SQL para comparar y lo sube a varias carpetas SFTP

Este archivo no lo borra, lo reemplaza al ejecutar el programa.

