# Proyecto Reporte diferencias de archivos

Este proyecto descarga un fichero json con el resumen de los metadatos que deberÃ­an de tener el cliente en una carpeta.
Se analizan diferencias y estas generan un archivo html

* Se sube a un sitio remoto.
* Se envÃ­a por mail a un operador.
* Si no hay diferencias no se envÃ­a nada.

---

## Estructura del proyecto

```bash
sincronizar_archivos_cliente/
â”‚
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ config.json           # ParÃ¡metros generales (directorio base, etc.)
â”‚   â””â”€â”€ credenciales.json     # Credenciales de acceso a sistemas externos que usamos o usaremos
â”‚
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ diferencias.html.j2   # Plantilla para poder renderizar un archivo HTML
â”‚
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ email_module.py       # Funciones genÃ©ricas para enviar un correo electrÃ³nico
â”‚   â”œâ”€â”€ logging_config.py     # Funciones genÃ©ricas para tener un log del programa
â”‚   â”œâ”€â”€ export.py             # Funciones genÃ©ricas para exportar informaciÃ³n de BBDD a SFTP
â”‚   â”œâ”€â”€ utils.py              # Funciones genÃ©ricas (cargar JSON)
â”‚   â”œâ”€â”€ files.py              # Utilidades para leer metadatos de ficheros
â”‚   â”œâ”€â”€ ssh.py                # Utilidades para usar un servidor ssh (sftp)
â”‚   â”œâ”€â”€ verificar.py          # Utilidades para verificar diferencias y generar reportes
â”‚   â””â”€â”€ sync.py               # Algoritmo de sincronizaciÃ³n
â”‚
â”œâ”€â”€ main.py                   # Punto de entrada principal
â””â”€â”€ README.md                 # DocumentaciÃ³n del proyecto

```

---

## âš™ï¸ ConfiguraciÃ³n

`config/config.json`

```json
{
  "carpeta_local": "Ruta local a colocar",
  "fichero_json_origen": "inventario_imagenes.json",
  "ruta_html_salida": "diferencias_inventario_imagenes.html",
  "accion_salida": "TODOS",  
  "documentacion_accion_salida" : "SFTP, EMAIL, TODOS",
  "ruta_remota_fichero": "Ruta remota donde estÃ¡ el fichero origina",
  "ruta_remota_salida": "Ruta remota donde depositar el informe generado",
  "servidor_nombre" : "Nombre del Cliente",
  "email": {
    "para": "operador@dominio.com",
    "asunto": "Diferencias con el repositorio central de imÃ¡genes con el cliente"
  },
    "log": {
    "ruta_log": "logs/cliente.log",
    "max_megas": 5,
    "copias": 3
  }
}

```

`config/credenciales.json`

```json
{
    "SFTP": [
    "servidor sftp",
    2222,
    "user sftp",
    "password user sftp",
    "",
    ""
    ],
    "CORREO" : [
        "noreply@dominio.com",
        "smtp.serviciodecorreo.es",
        465,
        "noreply@dominio.com",
        "pass user email"
    ]
}
```

---


## Requerimientos

Instala las dependencias necesarias (Python 3.9+):

```bash
pip install paramiko jinja2
```

TambiÃ©n se puede instalar mediante el comando

```bash
pip install -r requirements.txt
```

### Dependencias estÃ¡ndar de Python

* os, hashlib, mimetypes, datetime, json, smtp.

---

## â–¶ï¸ EjecuciÃ³n

* Configura config/config.json y config/credenciales.json.

Ejecuta el programa:
```bash
python main.py
```

---

## Logging del programa

El proyecto utiliza el mÃ³dulo logging de Python para registrar la actividad del script. Esto es especialmente Ãºtil cuando se ejecuta desde cron, ya que no hay consola visible.

### âš™ï¸ ConfiguraciÃ³n del log

Los parÃ¡metros del log se configuran en `config/config.json`:

```json
"log": {
  "ruta_log": "logs/cliente.log",
  "max_megas": 5,
  "copias": 5
}
```

* ruta_log: ruta del fichero donde se almacenan los logs.
* max_megas: tamaÃ±o mÃ¡ximo del fichero de log en MB antes de rotar.
* copias: nÃºmero de ficheros de log antiguos que se mantienen (rotaciÃ³n).
* El programa crea automÃ¡ticamente la carpeta logs/ si no existe.

### ğŸ“„ Comportamiento del log

* Se registra informaciÃ³n relevante del programa (INFO, WARNING, ERROR).
* Se silencian los mensajes INFO internos de paramiko, para no llenar el log con informaciÃ³n de SFTP.
* Cuando el fichero de log supera el tamaÃ±o mÃ¡ximo (max_megas), se rota automÃ¡ticamente, creando copias numeradas:

```bash
sincronizar_archivos.log        <-- log actual
sincronizar_archivos.log.1      <-- copia mÃ¡s reciente
sincronizar_archivos.log.2      <-- copia anterior
...
```

### ğŸ“ Ejemplo de entradas en el log

```bash
2025-10-04 13:26:44 [INFO] root: === INICIO DEL SCRIPT ===
2025-10-04 13:26:45 [INFO] modules.verificar: No hay diferencias. No se enviarÃ¡ ningÃºn HTML ni se subirÃ¡ a SFTP.
2025-10-04 13:26:45 [INFO] root: === FIN DEL SCRIPT ===
```

---

## Archivos generados

El programa genera un archivo json que se baja del sitio SFTP y no lo borra, lo reemplaza al ejecutar el programa.

Si no hay conexiÃ³n tendrÃ¡ uno con el que comparar antiguo.

Se genera un archivo .html con el informe de diferencias. Tampoco se borra y se reemplaza en cada ejecuciÃ³n. Puede que se suba o no dependiendo de la configuraciÃ³n o de si hay o no diferencias encontradas

Si la ruta donde busca no existe para el programa generarÃ¡ un archivo con todas las diferencias posibles.